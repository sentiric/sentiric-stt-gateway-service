networks:
  sentiric-stt-test-net:
    driver: bridge

volumes:
  stt_whisper_cache:

services:
  stt-gateway-service:
    # Bu servis, mevcut dizindeki Dockerfile'dan derlenecek.
    build:
      context: .
    env_file:
      - .env
    ports:
      # Servisin portlarını dış dünyaya açarak test istemcisinin erişmesini sağlıyoruz.
      - "15020:15020" # HTTP Health Check
      - "15021:15021" # gRPC
    networks:
      - sentiric-stt-test-net
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:15020/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      stt-whisper-service:
        condition: service_healthy

  stt-whisper-service:
    # Bu servis, hazır imajdan çekilir, tekrar derlemeye gerek yok.
    image: ghcr.io/sentiric/sentiric-stt-whisper-service:latest
    hostname: stt-whisper-service # Gateway'in bu isme erişebilmesi için
    env_file:
      - .env
    volumes:
      - stt_whisper_cache:/app/model-cache
    ports:
      # Portları açarak hem gateway'in erişmesini hem de doğrudan test etmeyi sağlıyoruz.
      - "15030:15030" # HTTP
      - "15031:15031" # gRPC
    networks:
      - sentiric-stt-test-net
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:15030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10m